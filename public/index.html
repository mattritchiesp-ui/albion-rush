<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Albion Departures</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #111;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 20px 16px 14px;
      border-bottom: 1px solid #1e1e1e;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #4fc3f7;
    }
    header p {
      font-size: 13px;
      color: #555;
      margin-top: 3px;
    }
    #clock {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
      letter-spacing: 0.02em;
    }

    main {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .departure {
      display: flex;
      align-items: center;
      background: #1e1e1e;
      border-radius: 10px;
      padding: 16px;
      gap: 16px;
      border-left: 3px solid transparent;
    }
    .departure.next {
      background: #1a2a35;
      border-left-color: #4fc3f7;
    }

    .dep-time {
      font-size: 20px;
      font-weight: 700;
      min-width: 82px;
      color: #fff;
    }

    .dep-line {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      color: #aaa;
    }
    .departure.next .dep-line {
      color: #ddd;
    }

    .dep-minutes {
      font-size: 30px;
      font-weight: 800;
      color: #4fc3f7;
      text-align: right;
      line-height: 1;
    }
    .dep-minutes .min-label {
      font-size: 11px;
      font-weight: 500;
      color: #555;
      display: block;
      text-align: right;
    }
    .dep-minutes.urgent {
      color: #ef5350;
    }

    .empty-msg {
      text-align: center;
      color: #555;
      padding: 40px 0;
      font-size: 15px;
    }

    .error-msg {
      background: #37474f;
      border-radius: 10px;
      padding: 16px;
      color: #cfd8dc;
      text-align: center;
      font-size: 14px;
    }

    footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px 24px;
      color: #444;
      font-size: 12px;
    }
    .refresh-btn {
      background: none;
      border: 1px solid #333;
      color: #666;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
    }
    .refresh-btn:hover { border-color: #888; color: #fff; }
  </style>
</head>
<body>

<header>
  <div>
    <h1>Albion</h1>
    <p>Next trains toward Roma Street</p>
  </div>
  <div id="clock"></div>
</header>

<main id="list">
  <div class="empty-msg">Loading...</div>
</main>

<footer>
  <span id="updated">—</span>
  <button class="refresh-btn" onclick="load()">↻ Refresh</button>
</footer>

<script>
  let tickTimer = null;

  function formatTime(ts) {
    return new Date(ts * 1000)
      .toLocaleTimeString('en-AU', { hour: 'numeric', minute: '2-digit', hour12: true })
      .replace(/am|pm/i, m => m.toUpperCase());
  }

  async function load() {
    try {
      const res = await fetch('/api/departures');
      if (!res.ok) throw new Error(await res.text());
      const { departures, fetchedAt } = await res.json();

      const list = document.getElementById('list');

      if (!departures || departures.length === 0) {
        list.innerHTML = '<div class="empty-msg">No departures found</div>';
      } else {
        list.innerHTML = departures.map((d, i) => `
          <div class="departure${i === 0 ? ' next' : ''}">
            <div class="dep-time">${formatTime(d.departureTs)}</div>
            <div class="dep-line">${d.line}</div>
            <div class="dep-minutes${d.minutes < 5 ? ' urgent' : ''}">
              ${d.minutes}<span class="min-label">min</span>
            </div>
          </div>
        `).join('');
      }

      // Tick counter
      clearInterval(tickTimer);
      const loadedAt = Date.now();
      const updEl = document.getElementById('updated');
      const tick = () => {
        const secs = Math.round((Date.now() - loadedAt) / 1000);
        updEl.textContent = secs < 5 ? 'Just updated' : `Updated ${secs}s ago`;
      };
      tick();
      tickTimer = setInterval(tick, 1000);

    } catch (err) {
      document.getElementById('list').innerHTML =
        `<div class="error-msg">Could not fetch live data.<br>${err.message}</div>`;
    }
  }

  function updateClock() {
    document.getElementById('clock').textContent = new Date()
      .toLocaleTimeString('en-AU', { hour: 'numeric', minute: '2-digit', hour12: true })
      .replace(/am|pm/i, m => m.toUpperCase());
  }
  updateClock();
  setInterval(updateClock, 1000);

  setInterval(load, 20000);
  load();
</script>

</body>
</html>
