<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Albion Departures</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #111;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 16px 14px;
      border-bottom: 1px solid #1e1e1e;
    }
    header h1 {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #4fc3f7;
    }
    header p {
      font-size: 13px;
      color: #555;
      margin-top: 3px;
    }
    #clock {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
      letter-spacing: 0.02em;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: #1a1a1a;
      border-bottom: 2px solid #222;
    }
    .tab {
      flex: 1;
      padding: 13px 8px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      border: none;
      background: none;
      letter-spacing: 0.03em;
      transition: color 0.15s;
    }
    .tab.active {
      color: #fff;
      border-bottom: 3px solid #4fc3f7;
      margin-bottom: -2px;
    }
    .tab:hover:not(.active) { color: #aaa; }

    /* Views */
    .view { display: none; flex: 1; flex-direction: column; }
    .view.active { display: flex; }

    main {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .departure {
      display: flex;
      align-items: center;
      background: #1e1e1e;
      border-radius: 10px;
      padding: 16px;
      gap: 16px;
      border-left: 3px solid transparent;
    }
    .departure.next {
      background: #1a2a35;
      border-left-color: #4fc3f7;
    }

    .dep-time {
      font-size: 20px;
      font-weight: 700;
      min-width: 82px;
      color: #fff;
    }

    .dep-line {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      color: #aaa;
    }
    .departure.next .dep-line { color: #ddd; }

    .dep-platform {
      background: #263238;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 13px;
      font-weight: 700;
      color: #4fc3f7;
      white-space: nowrap;
    }

    .dep-minutes {
      font-size: 30px;
      font-weight: 800;
      color: #4fc3f7;
      text-align: right;
      line-height: 1;
      min-width: 52px;
    }
    .dep-minutes .min-label {
      font-size: 11px;
      font-weight: 500;
      color: #555;
      display: block;
      text-align: right;
    }
    .dep-minutes.urgent { color: #ef5350; }

    .empty-msg {
      text-align: center;
      color: #555;
      padding: 40px 0;
      font-size: 15px;
    }

    .error-msg {
      background: #37474f;
      border-radius: 10px;
      padding: 16px;
      color: #cfd8dc;
      text-align: center;
      font-size: 14px;
    }

    footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px 24px;
      color: #444;
      font-size: 12px;
    }
    .refresh-btn {
      background: none;
      border: 1px solid #333;
      color: #666;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
    }
    .refresh-btn:hover { border-color: #888; color: #fff; }
  </style>
</head>
<body>

<header>
  <div>
    <h1 id="header-title">Albion</h1>
    <p id="header-sub">Next trains toward Roma Street</p>
  </div>
  <div id="clock"></div>
</header>

<div class="tabs">
  <button class="tab active" data-mode="albion" onclick="switchTab('albion')">Albion</button>
  <button class="tab" data-mode="roma-milton" onclick="switchTab('roma-milton')">→ Milton</button>
</div>

<div class="view active" id="view-albion">
  <main id="list-albion"><div class="empty-msg">Loading...</div></main>
  <footer>
    <span id="updated-albion">—</span>
    <button class="refresh-btn" onclick="load('albion')">↻ Refresh</button>
  </footer>
</div>

<div class="view" id="view-roma-milton">
  <main id="list-roma-milton"><div class="empty-msg">Loading...</div></main>
  <footer>
    <span id="updated-roma-milton">—</span>
    <button class="refresh-btn" onclick="load('roma-milton')">↻ Refresh</button>
  </footer>
</div>

<script>
  const HEADERS = {
    'albion':      { title: 'Albion',      sub: 'Next trains toward Roma Street' },
    'roma-milton': { title: 'Roma Street', sub: 'Next trains stopping at Milton' },
  };

  let currentTab = 'albion';
  let tickTimers = {};

  function formatTime(ts) {
    return new Date(ts * 1000)
      .toLocaleTimeString('en-AU', { hour: 'numeric', minute: '2-digit', hour12: true })
      .replace(/am|pm/i, m => m.toUpperCase());
  }

  function updateClock() {
    document.getElementById('clock').textContent = formatTime(Date.now() / 1000);
  }

  async function load(mode) {
    try {
      const res = await fetch(`/api/departures?mode=${mode}`);
      if (!res.ok) throw new Error(await res.text());
      const { departures, fetchedAt } = await res.json();

      const list = document.getElementById(`list-${mode}`);

      if (!departures || departures.length === 0) {
        list.innerHTML = '<div class="empty-msg">No departures found</div>';
      } else {
        list.innerHTML = departures.map((d, i) => {
          const platformBadge = d.platform
            ? `<div class="dep-platform">Plat ${d.platform}</div>`
            : '';
          return `
            <div class="departure${i === 0 ? ' next' : ''}">
              <div class="dep-time">${formatTime(d.departureTs)}</div>
              <div class="dep-line">${d.line}</div>
              ${platformBadge}
              <div class="dep-minutes${d.minutes < 5 ? ' urgent' : ''}">
                ${d.minutes}<span class="min-label">min</span>
              </div>
            </div>
          `;
        }).join('');
      }

      // Tick counter
      clearInterval(tickTimers[mode]);
      const loadedAt = Date.now();
      const updEl = document.getElementById(`updated-${mode}`);
      const tick = () => {
        const secs = Math.round((Date.now() - loadedAt) / 1000);
        updEl.textContent = secs < 5 ? 'Just updated' : `Updated ${secs}s ago`;
      };
      tick();
      tickTimers[mode] = setInterval(tick, 1000);

    } catch (err) {
      document.getElementById(`list-${mode}`).innerHTML =
        `<div class="error-msg">Could not fetch live data.<br>${err.message}</div>`;
    }
  }

  function switchTab(mode) {
    currentTab = mode;

    document.querySelectorAll('.tab').forEach(t => {
      t.classList.toggle('active', t.dataset.mode === mode);
    });
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(`view-${mode}`).classList.add('active');

    const h = HEADERS[mode];
    document.getElementById('header-title').textContent = h.title;
    document.getElementById('header-sub').textContent = h.sub;

    load(mode);
  }

  // Auto-refresh every 20s for current tab
  setInterval(() => load(currentTab), 20000);

  // Clock
  updateClock();
  setInterval(updateClock, 1000);

  // Initial load
  load('albion');
</script>

</body>
</html>
